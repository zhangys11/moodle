define("core_reportbuilder/local/editor/columns",["exports","core/event_dispatcher","core/inplace_editable","core/local/inplace_editable/events","core/notification","core/pending","core/prefetch","core/pubsub","core/sortable_list","core/str","core/toast","core_reportbuilder/local/events","core_reportbuilder/local/selectors","core_reportbuilder/local/repository/columns","core_reportbuilder/local/repository/sorting"],(function(_exports,_event_dispatcher,_inplace_editable,_events,_notification,_pending,_prefetch,_pubsub,_sortable_list,_str,_toast,reportEvents,reportSelectors,_columns,_sorting){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_notification=_interopRequireDefault(_notification),_pending=_interopRequireDefault(_pending),_sortable_list=_interopRequireDefault(_sortable_list),reportEvents=_interopRequireWildcard(reportEvents),reportSelectors=_interopRequireWildcard(reportSelectors);_exports.init=initialized=>{if((0,_prefetch.prefetchStrings)("core_reportbuilder",["columnadded","columnaggregated","columndeleted","columnmoved","deletecolumn","deletecolumnconfirm"]),(0,_prefetch.prefetchStrings)("core",["delete"]),initialized)return;document.addEventListener("click",(event=>{const reportAddColumn=event.target.closest(reportSelectors.actions.reportAddColumn);if(reportAddColumn){event.preventDefault();const pendingPromise=new _pending.default("core_reportbuilder/columns:add"),reportElement=reportAddColumn.closest(reportSelectors.regions.report);(0,_columns.addColumn)(reportElement.dataset.reportId,reportAddColumn.dataset.uniqueIdentifier).then((data=>(0,_pubsub.publish)(reportEvents.publish.reportColumnsUpdated,data))).then((()=>(0,_str.getString)("columnadded","core_reportbuilder",reportAddColumn.dataset.name))).then(_toast.add).then((()=>((0,_event_dispatcher.dispatchEvent)(reportEvents.tableReload,{preservePagination:!0},reportElement),pendingPromise.resolve()))).catch(_notification.default.exception)}const reportRemoveColumn=event.target.closest(reportSelectors.actions.reportRemoveColumn);if(reportRemoveColumn){event.preventDefault();const reportElement=reportRemoveColumn.closest(reportSelectors.regions.report),columnHeader=reportRemoveColumn.closest(reportSelectors.regions.columnHeader),columnName=columnHeader.dataset.columnName;_notification.default.saveCancelPromise((0,_str.getString)("deletecolumn","core_reportbuilder",columnName),(0,_str.getString)("deletecolumnconfirm","core_reportbuilder",columnName),(0,_str.getString)("delete","core"),{triggerElement:reportRemoveColumn}).then((()=>{const pendingPromise=new _pending.default("core_reportbuilder/columns:remove");return(0,_columns.deleteColumn)(reportElement.dataset.reportId,columnHeader.dataset.columnId).then((data=>(0,_pubsub.publish)(reportEvents.publish.reportColumnsUpdated,data))).then((()=>(0,_toast.add)((0,_str.getString)("columndeleted","core_reportbuilder",columnName)))).then((()=>((0,_event_dispatcher.dispatchEvent)(reportEvents.tableReload,{preservePagination:!0},reportElement),pendingPromise.resolve()))).catch(_notification.default.exception)})).catch((()=>{}))}}));const columnHeadingSelector="".concat(reportSelectors.regions.reportTable," thead tr");new _sortable_list.default(columnHeadingSelector,{isHorizontal:!0}).getElementName=element=>Promise.resolve(element.data("columnName")),document.addEventListener(_sortable_list.default.EVENTS.elementDrag,(event=>{const reportOrderColumn=event.target.closest("".concat(columnHeadingSelector," ").concat(reportSelectors.regions.columnHeader));if(reportOrderColumn){const reportElement=event.target.closest(reportSelectors.regions.report),{columnPosition:columnPosition}=reportOrderColumn.dataset,targetColumnPosition=event.detail.targetNextElement.data("columnPosition");reportElement.querySelectorAll("".concat(reportSelectors.regions.reportTable," tbody tr")).forEach((reportTableRow=>{const reportTableRowCell=reportTableRow.querySelector("td.c".concat(columnPosition-1));if(targetColumnPosition){const reportTableRowCellTarget=reportTableRow.querySelector("td.c".concat(targetColumnPosition-1));reportTableRow.insertBefore(reportTableRowCell,reportTableRowCellTarget)}else reportTableRow.appendChild(reportTableRowCell)}))}})),document.addEventListener(_sortable_list.default.EVENTS.elementDrop,(event=>{const reportOrderColumn=event.target.closest("".concat(columnHeadingSelector," ").concat(reportSelectors.regions.columnHeader));if(reportOrderColumn&&event.detail.positionChanged){const pendingPromise=new _pending.default("core_reportbuilder/columns:reorder"),reportElement=reportOrderColumn.closest(reportSelectors.regions.report),{columnId:columnId,columnPosition:columnPosition,columnName:columnName}=reportOrderColumn.dataset;let targetColumnPosition=event.detail.targetNextElement.data("columnPosition")||event.detail.element.siblings().length+2;targetColumnPosition>columnPosition&&targetColumnPosition--;const reorderPromise=(0,_columns.reorderColumn)(reportElement.dataset.reportId,columnId,targetColumnPosition);Promise.all([reorderPromise,new Promise((resolve=>setTimeout(resolve,1e3)))]).then((()=>(0,_str.getString)("columnmoved","core_reportbuilder",columnName))).then(_toast.add).then((()=>((0,_event_dispatcher.dispatchEvent)(reportEvents.tableReload,{preservePagination:!0},reportElement),pendingPromise.resolve()))).catch(_notification.default.exception)}})),document.addEventListener(_events.eventTypes.elementUpdated,(event=>{const columnAggregation=event.target.closest('[data-itemtype="columnaggregation"]');if(columnAggregation){const pendingPromise=new _pending.default("core_reportbuilder/columns:aggregate"),reportElement=columnAggregation.closest(reportSelectors.regions.report),columnHeader=columnAggregation.closest(reportSelectors.regions.columnHeader);(0,_str.getString)("columnaggregated","core_reportbuilder",columnHeader.dataset.columnName).then(_toast.add).then((()=>{const columnAggregationLink='[data-itemtype="columnaggregation"][data-itemid="'+"".concat(columnAggregation.dataset.itemid,'"] > a');return(0,_event_dispatcher.dispatchEvent)(reportEvents.tableReload,{preserveTriggerElement:columnAggregationLink},reportElement),(0,_sorting.getColumnSorting)(reportElement.dataset.reportId)})).then((data=>(0,_pubsub.publish)(reportEvents.publish.reportColumnsUpdated,data))).then((()=>pendingPromise.resolve())).catch(_notification.default.exception)}}))}}));

//# sourceMappingURL=columns.min.js.map